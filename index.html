<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artlist Prompt Journey</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            padding-left: calc(2rem + 60px);
            transition: padding-left 0.3s ease;
        }

        .header-logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin-bottom: 3rem;
            position: relative;
        }

        .settings-btn {
            position: absolute;
            top: 0;
            right: 0;
            width: 40px;
            height: 40px;
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 50%;
            color: #e0e0e0;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .settings-btn:hover {
            background: #333;
            border-color: #FFC107;
            color: #FFC107;
            transform: rotate(90deg);
        }

        .header-logo img {
            height: 80px;
            width: auto;
        }

        h1 {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }

        .logo-text {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 2rem;
            font-weight: 600;
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Gallery Section */
        .gallery-section {
            margin-top: 3rem;
        }

        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .gallery-header h2 {
            font-size: 1.5rem;
            color: #e0e0e0;
        }

        .upload-btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .save-disk-btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: none;
        }

        .save-disk-btn.show {
            display: block;
        }

        .save-disk-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(86, 171, 47, 0.3);
        }

        .gallery-buttons {
            display: flex;
            gap: 0.75rem;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 3rem;
        }

        .gallery-item {
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            cursor: grab;
            transition: transform 0.3s, box-shadow 0.3s;
            background: #1a1a1a;
            border: 2px solid transparent;
            position: relative;
        }

        .gallery-item:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            border-color: #FFC107;
        }

        .gallery-item:active {
            cursor: grabbing;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .gallery-item-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 18px;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }

        .gallery-item:hover .gallery-item-delete {
            display: flex;
        }

        .gallery-item-delete:hover {
            background: #ff4444;
            transform: scale(1.1);
        }

        /* Description Section */
        .description-section {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .drop-zone-hint {
            text-align: center;
            color: #888;
            font-size: 0.95rem;
            margin-top: 2rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .drop-zone-hint:hover {
            color: #FFC107;
            background: rgba(102, 126, 234, 0.05);
        }

        .drop-zone-hint.hidden {
            display: none;
        }

        .drop-zone {
            border: 3px dashed #444;
            border-radius: 16px;
            padding: 0;
            max-height: 0;
            overflow: hidden;
            text-align: center;
            transition: all 0.4s ease;
            margin-top: 2rem;
            position: relative;
            background: #0f0f0f;
            opacity: 0;
        }

        .drop-zone:hover,
        .drop-zone.dragging-over-page {
            padding: 3rem;
            max-height: 500px;
            opacity: 1;
        }

        .drop-zone.drag-over {
            border-color: #FFC107;
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.02);
            padding: 3rem;
            max-height: 500px;
            opacity: 1;
        }

        .drop-zone.has-image {
            padding: 1rem;
            max-height: 500px;
            opacity: 1;
            border-style: solid;
            border-color: #FFC107;
            width: fit-content;
            margin: 2rem auto;
            min-width: 160px;
        }

        .drop-instructions {
            color: #888;
            margin-bottom: 1rem;
        }

        .drop-zone-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .preview-container {
            width: 120px;
            height: 120px;
            position: relative;
            display: none;
            margin: 0 auto;
        }

        .preview-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .remove-image:hover {
            transform: scale(1.1);
            background: #ff6666;
        }

        .prompt-area {
            margin-bottom: 1.5rem;
        }

        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .prompt-area label {
            color: #e0e0e0;
            font-weight: 500;
        }

        .button-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.5rem 1rem;
            background: #333;
            border: 2px solid #444;
            border-radius: 8px;
            color: white;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .action-btn:hover {
            background: #444;
            border-color: #FFC107;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .recommend-btn {
            background: #ffa500;
            border-color: #ffa500;
            position: relative;
        }

        .recommend-btn:hover:not(:disabled) {
            background: #ff8c00;
            border-color: #ff8c00;
        }

        .recommend-btn:hover:not(:disabled)::after {
            content: 'Generates an amazing random prompt in Artlist style';
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            white-space: nowrap;
            border: 2px solid #ffa500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            pointer-events: none;
            animation: tooltipFadeIn 0.2s ease;
        }

        .recommend-btn:hover:not(:disabled)::before {
            content: '';
            position: absolute;
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #ffa500;
            z-index: 1001;
            pointer-events: none;
        }

        .recommend-btn.loading {
            position: relative;
            overflow: hidden;
        }

        .recommend-btn.loading::before,
        .recommend-btn.loading::after {
            display: none;
        }

        .recommend-btn.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 1.5s infinite;
            display: block;
        }

        .improve-btn {
            background: #9b59b6;
            border-color: #9b59b6;
            position: relative;
        }

        .improve-btn:hover:not(:disabled) {
            background: #8e44ad;
            border-color: #8e44ad;
        }

        .improve-btn:hover:not(:disabled)::after {
            content: 'Enhances your prompt to Artlist EyeCandy style';
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            white-space: nowrap;
            border: 2px solid #9b59b6;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            pointer-events: none;
            animation: tooltipFadeIn 0.2s ease;
        }

        .improve-btn:hover:not(:disabled)::before {
            content: '';
            position: absolute;
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #9b59b6;
            z-index: 1001;
            pointer-events: none;
        }

        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(4px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .improve-btn.loading {
            position: relative;
            overflow: hidden;
        }

        .improve-btn.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        .improve-btn.loading::before {
            display: none;
        }

        .improve-btn:disabled:hover::after {
            content: 'Enhances your prompt to Artlist EyeCandy style (enter a prompt first)';
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a1a;
            color: #888;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            white-space: nowrap;
            border: 2px solid #444;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            pointer-events: none;
            animation: tooltipFadeIn 0.2s ease;
        }

        .improve-btn:disabled:hover::before {
            content: '';
            position: absolute;
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #444;
            z-index: 1001;
            pointer-events: none;
        }

        .copy-btn.copied {
            background: #28a745;
            border-color: #28a745;
        }

        /* Aspect Ratio Selector */
        .aspect-ratio-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .aspect-ratio-group label {
            color: #888;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .aspect-ratio-select {
            padding: 0.5rem;
            background: #0f0f0f;
            border: 2px solid #444;
            border-radius: 8px;
            color: white;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .aspect-ratio-select:hover {
            border-color: #FFC107;
        }

        .aspect-ratio-select:focus {
            outline: none;
            border-color: #FFC107;
        }

        .button-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .prompt-area textarea {
            width: 100%;
            min-height: 120px;
            background: #0f0f0f;
            border: 2px solid #333;
            border-radius: 12px;
            color: white;
            padding: 1rem;
            font-size: 1rem;
            resize: vertical;
            transition: border-color 0.3s, opacity 0.3s;
        }

        .prompt-area textarea:focus {
            outline: none;
            border-color: #FFC107;
        }

        .prompt-area textarea.loading {
            opacity: 0.5;
            pointer-events: none;
            position: relative;
        }

        .prompt-area textarea.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.2), transparent);
            animation: textShimmer 1.5s infinite;
        }

        @keyframes textShimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        .describe-btn {
            flex: 1;
            padding: 1rem;
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }

        .describe-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .describe-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .describe-btn.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        .generate-btn-main {
            flex: 1;
            padding: 1rem;
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }

        .generate-btn-main:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(245, 87, 108, 0.4);
        }

        .generate-btn-main:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .generate-btn-main.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        .randomize-btn {
            flex: 1;
            padding: 1rem;
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: visible;
        }

        .randomize-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(86, 171, 47, 0.4);
        }

        .randomize-btn:hover:not(:disabled)::before {
            content: 'Randomizes camera angle and action in Artlist EyeCandy style';
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            white-space: nowrap;
            border: 2px solid #56ab2f;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            pointer-events: none;
            animation: tooltipFadeIn 0.2s ease;
        }

        .randomize-btn:hover:not(:disabled)::after {
            content: '';
            position: absolute;
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #56ab2f;
            z-index: 1001;
            pointer-events: none;
        }

        .randomize-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .randomize-btn:disabled:hover::before {
            content: 'Randomizes camera angle and action in Artlist EyeCandy style (upload an image first)';
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a1a;
            color: #888;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            white-space: nowrap;
            border: 2px solid #444;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            pointer-events: none;
            animation: tooltipFadeIn 0.2s ease;
            display: block;
        }

        .randomize-btn:disabled:hover::after {
            content: '';
            position: absolute;
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #444;
            z-index: 1001;
            pointer-events: none;
            display: block;
        }

        .randomize-btn.loading {
            overflow: hidden;
        }

        .randomize-btn.loading::before,
        .randomize-btn.loading::after {
            display: none;
        }

        .randomize-btn.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 1.5s infinite;
            display: block;
        }

        /* Generated Images Section */
        .generated-section {
            margin-top: 2rem;
            display: none;
        }

        .generated-section.active {
            display: block;
        }

        .generated-section h3 {
            color: #e0e0e0;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        .generated-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .generated-tile {
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            background: #0f0f0f;
            border: 2px solid #333;
            position: relative;
            transition: transform 0.3s, border-color 0.3s;
        }

        .generated-tile[draggable="true"] {
            cursor: grab;
        }

        .generated-tile[draggable="true"]:active {
            cursor: grabbing;
        }

        .generated-tile:hover {
            transform: scale(1.02);
            border-color: #FFC107;
        }

        .generated-tile:hover .save-to-gallery-btn {
            opacity: 1;
        }

        .save-to-gallery-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #FFC107;
            border-radius: 8px;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            z-index: 10;
            display: none;
        }

        .save-to-gallery-btn:hover {
            background: #FFC107;
            transform: scale(1.1);
        }

        .save-to-gallery-btn.saved {
            background: #28a745;
            border-color: #28a745;
        }

        .generated-tile.has-image .save-to-gallery-btn {
            display: block;
        }

        .tile-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 0.875rem;
            text-align: center;
        }

        .tile-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }

        .tile-image[draggable="true"] {
            cursor: grab;
        }

        .tile-image[draggable="true"]:active {
            cursor: grabbing;
        }

        .generated-tile.loading .tile-placeholder::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        @keyframes shimmer {
            100% {
                left: 100%;
            }
        }

        /* Hidden file input */
        #fileInput, #galleryInput {
            display: none;
        }

        /* Drag overlay */
        .drag-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(102, 126, 234, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .drag-overlay.show {
            display: flex;
        }

        .drag-overlay-content {
            text-align: center;
            color: white;
        }

        .drag-overlay-content h2 {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .drag-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        /* Image lightbox */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            cursor: pointer;
        }

        .lightbox.active {
            display: flex;
        }

        .lightbox-content {
            position: relative;
            max-width: 95vw;
            max-height: 95vh;
            cursor: default;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0.25rem;
            /* Hide scrollbar completely */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }

        .lightbox-content::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .lightbox-image {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .lightbox-close {
            position: absolute;
            top: -40px;
            right: -40px;
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 50%;
            color: #333;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .lightbox-close:hover {
            background: #ff4444;
            color: white;
            transform: scale(1.1);
        }

        .lightbox-save {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: none;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            white-space: nowrap;
            z-index: 1001;
            opacity: 0;
            pointer-events: none;
        }

        .lightbox-content:hover .lightbox-save {
            opacity: 1;
            pointer-events: auto;
        }

        .lightbox-save:hover {
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }

        .lightbox-save.show {
            display: flex;
        }

        .lightbox-edit {
            position: absolute;
            top: 20px;
            right: 100px;
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            border: none;
            border-radius: 12px;
            color: #000;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            opacity: 0;
            font-size: 14px;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .lightbox-content:hover .lightbox-edit {
            opacity: 1;
        }

        .lightbox-content.editing .lightbox-edit {
            display: none;
        }

        .lightbox-content.editing .lightbox-image {
            max-height: 50vh;
            margin-bottom: 0.25rem;
            transition: all 0.4s ease;
        }

        .lightbox-content.editing .lightbox-prompt {
            display: none;
        }

        .lightbox-content.editing .lightbox-nav {
            display: none;
        }

        .lightbox-content.editing .comparison-view {
            /* Remove max-height restriction to prevent overlap */
        }
        
        /* Hide prompt bubble when editing or comparison is active */
        .lightbox-content.editing .lightbox-prompt,
        .comparison-view.active ~ .lightbox-prompt {
            display: none !important;
        }

        .edit-interface {
            width: 100%;
            max-width: 550px;
            display: none;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.5rem;
            background: #1a1a1a;
            padding: 1rem;
            border-radius: 12px;
            border: 2px solid #333;
            align-self: center;
        }

        .lightbox-content.editing .edit-interface {
            display: flex;
        }

        .edit-interface.active {
            display: flex;
        }

        /* When comparison view is active, add minimal top margin to edit interface */
        .comparison-view.active ~ .edit-interface {
            margin-top: 0.5rem;
        }

        /* Better layout for portrait images */
        @media (max-width: 768px) {
            .edit-interface {
                max-width: calc(100vw - 2rem);
            }
        }

        .edit-reference-section {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .edit-reference-label {
            color: #888;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .edit-reference-upload {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .edit-upload-btn {
            padding: 0.5rem 1rem;
            background: #333;
            border: 2px solid #444;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
            font-size: 0.85rem;
        }

        .edit-upload-btn:hover {
            background: #444;
            border-color: #FFC107;
        }

        /* Hide the file input text */
        #editReferenceInput {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0;
        }

        .edit-reference-preview {
            display: none;
            position: relative;
            width: 60px;
            height: 60px;
        }

        .edit-reference-preview.show {
            display: block;
        }

        .edit-reference-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid #444;
        }

        .edit-reference-remove {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .edit-reference-remove:hover {
            transform: scale(1.1);
            background: #ff6666;
        }

        .edit-textarea {
            width: 100%;
            min-height: 60px;
            padding: 0.75rem;
            background: #0f0f0f;
            border: 2px solid #333;
            border-radius: 8px;
            color: #ffffff;
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
            line-height: 1.4;
        }

        .edit-textarea:focus {
            outline: none;
            border-color: #FFC107;
        }

        .edit-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 0.25rem;
        }

        .edit-submit-btn {
            padding: 0.625rem 1.25rem;
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .edit-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 193, 7, 0.3);
        }

        .edit-cancel-btn {
            padding: 0.625rem 1.25rem;
            background: #333;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .edit-cancel-btn:hover {
            background: #444;
        }

        .editing-animation {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            background: rgba(255, 193, 7, 0.1);
            border: 2px solid rgba(255, 193, 7, 0.3);
            border-radius: 12px;
            margin-top: 0.5rem;
            min-height: 90px;
        }

        .editing-animation.active {
            display: flex;
        }

        .editing-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 193, 7, 0.2);
            border-top-color: #FFC107;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .editing-text {
            color: #FFC107;
            font-weight: 600;
            font-size: 14px;
        }

        .editing-subtext {
            color: #999;
            font-size: 12px;
        }

        .edit-interface.active {
            max-height: 350px;
            overflow: visible;
        }

        .comparison-view {
            display: none;
            flex-direction: row;
            gap: 1.5rem;
            width: 100%;
            max-width: 95vw;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .comparison-view.active {
            display: flex;
        }

        .lightbox-content.editing .comparison-view.active {
            overflow: visible;
            margin-bottom: 0.5rem;
            /* Allow natural height based on image sizes */
        }

        .comparison-side {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            min-width: 350px;
            max-width: 45vw;
        }

        .comparison-label {
            color: #999;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.25rem;
        }

        .comparison-image {
            max-width: 100%;
            max-height: 65vh;
            border-radius: 8px;
            border: 2px solid #333;
        }

        .lightbox-content.editing .comparison-image {
            max-height: 45vh;
        }

        .comparison-close {
            margin-top: 0.25rem;
            margin-bottom: 0.25rem;
            padding: 0.5rem 1.5rem;
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .comparison-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 193, 7, 0.3);
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            color: #333;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .lightbox-nav:hover {
            background: white;
            transform: translateY(-50%) scale(1.1);
        }

        .lightbox-prev {
            left: -70px;
        }

        .lightbox-next {
            right: -70px;
        }

        @media (max-width: 768px) {
            .lightbox-close {
                top: 10px;
                right: 10px;
            }

            .lightbox-save {
                top: 10px;
                left: 50%;
                font-size: 12px;
                padding: 0.5rem 1rem;
            }

            .lightbox-prev {
                left: 10px;
            }

            .lightbox-next {
                right: 10px;
            }
        }

        /* History Sidebar */
        .history-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 60px;
            background: #1a1a1a;
            border-right: 2px solid #333;
            transition: width 0.3s ease;
            z-index: 1000;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .history-sidebar:hover {
            width: 320px;
        }

        .history-header {
            padding: 1.5rem;
            border-bottom: 2px solid #333;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 1rem;
            justify-content: center;
        }

        .history-icon {
            font-size: 16px;
            font-weight: 700;
            color: #FFC107;
            min-width: auto;
            letter-spacing: 0.5px;
        }

        .history-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #e0e0e0;
            opacity: 0;
            transition: opacity 0.3s ease 0.1s;
        }

        .history-sidebar:hover .history-title {
            opacity: 1;
        }

        .history-items {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            /* Better scrollbar styling - autohide */
            scrollbar-width: thin;
            scrollbar-color: transparent transparent;
        }

        .history-items:hover {
            scrollbar-color: #FFC107 #1a1a1a;
        }

        .history-items::-webkit-scrollbar {
            width: 6px;
        }

        .history-items::-webkit-scrollbar-track {
            background: transparent;
        }

        .history-items::-webkit-scrollbar-thumb {
            background: transparent;
            border-radius: 3px;
        }

        .history-items:hover::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .history-items:hover::-webkit-scrollbar-thumb {
            background: #FFC107;
        }

        .history-items::-webkit-scrollbar-thumb:hover {
            background: #FF9800;
        }

        .history-item {
            background: #0f0f0f;
            border: 2px solid #333;
            border-radius: 12px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease 0.2s, transform 0.2s, border-color 0.2s;
        }

        .history-sidebar:hover .history-item {
            opacity: 1;
        }

        .history-item:hover {
            border-color: #FFC107;
            transform: translateX(4px);
        }

        .history-item-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.25rem;
            width: 100%;
        }

        .history-item-image {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 6px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .history-item-image:hover {
            transform: scale(1.05);
        }

        .history-item-prompt {
            color: #888;
            font-size: 0.85rem;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item-time {
            color: #666;
            font-size: 0.75rem;
        }

        .history-empty {
            text-align: center;
            color: #666;
            padding: 2rem 1rem;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s ease 0.2s;
        }

        .history-sidebar:hover .history-empty {
            opacity: 1;
        }

        /* Prompt overlay on lightbox */
        .lightbox-prompt {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            color: white;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 60px;
            overflow: hidden;
        }

        .lightbox-prompt.show {
            display: block;
        }

        .lightbox-prompt:hover {
            max-width: 90vw;
        }

        .prompt-bubble {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 14px;
            white-space: nowrap;
        }

        .lightbox-prompt:hover .prompt-bubble {
            white-space: normal;
        }

        .prompt-bubble-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .prompt-bubble-text {
            flex: 1;
            opacity: 0;
            max-width: 0;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: inherit;
            line-height: 1.5;
        }

        .lightbox-prompt:hover .prompt-bubble-text {
            opacity: 1;
            max-width: calc(90vw - 150px);
            margin-left: 0.5rem;
        }

        .prompt-copy-btn {
            background: #FFC107;
            border: none;
            border-radius: 8px;
            color: white;
            padding: 0.5rem 0.75rem;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            opacity: 0;
            max-width: 0;
            overflow: hidden;
            flex-shrink: 0;
        }

        .lightbox-prompt:hover .prompt-copy-btn {
            opacity: 1;
            max-width: 100px;
            margin-left: 0.5rem;
        }

        .prompt-copy-btn:hover {
            background: #FF9800;
            transform: scale(1.05);
        }

        .prompt-copy-btn.copied {
            background: #28a745;
        }

        /* Chat Bubble */
        .chat-bubble {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 1500;
            font-size: 28px;
        }

        .chat-bubble:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(102, 126, 234, 0.6);
        }

        .chat-bubble.active {
            background: #FF9800;
        }

        /* Quality Warning Modal */
        .quality-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            backdrop-filter: blur(10px);
        }

        .quality-modal.active {
            display: flex;
        }

        .quality-modal-content {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .quality-modal-icon {
            text-align: center;
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .quality-modal-title {
            text-align: center;
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .quality-modal-score {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #FF9800;
        }

        .quality-modal-message {
            text-align: center;
            color: #e0e0e0;
            line-height: 1.6;
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        .quality-modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .quality-modal-btn {
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
        }

        .quality-modal-btn-improve {
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            color: #000;
        }

        .quality-modal-btn-improve:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 193, 7, 0.4);
        }

        .quality-modal-btn-continue {
            background: #333;
            color: white;
            border: 2px solid #444;
        }

        .quality-modal-btn-continue:hover {
            background: #444;
            border-color: #FFC107;
        }

        /* Quality Modal Toggle */
        .quality-modal-toggle {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #333;
            text-align: center;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            cursor: pointer;
            user-select: none;
        }

        .toggle-container input[type="checkbox"] {
            display: none;
        }

        .toggle-slider {
            position: relative;
            width: 44px;
            height: 24px;
            background: #333;
            border-radius: 24px;
            transition: background 0.3s;
            border: 2px solid #444;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #666;
            top: 1px;
            left: 1px;
            transition: all 0.3s;
        }

        .toggle-container input[type="checkbox"]:checked + .toggle-slider {
            background: #FFC107;
            border-color: #FFC107;
        }

        .toggle-container input[type="checkbox"]:checked + .toggle-slider::before {
            background: white;
            transform: translateX(20px);
        }

        .toggle-label {
            color: #e0e0e0;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .toggle-hint {
            color: #888;
            font-size: 0.75rem;
            margin-top: 0.5rem;
            margin-bottom: 0;
            font-style: italic;
        }

        /* Chat Modal */
        .chat-modal {
            position: fixed;
            bottom: 100px;
            right: 2rem;
            width: 400px;
            height: 600px;
            background: #1a1a1a;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            display: none;
            flex-direction: column;
            z-index: 1500;
            overflow: hidden;
            border: 2px solid #333;
        }

        .chat-modal.active {
            display: flex;
        }

        .chat-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            margin: 0;
            font-size: 1.25rem;
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .chat-close:hover {
            transform: scale(1.2);
        }

        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            /* Better scrollbar styling - autohide */
            scrollbar-width: thin;
            scrollbar-color: transparent transparent;
        }

        .chat-messages:hover {
            scrollbar-color: #FFC107 #1a1a1a;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: transparent;
            border-radius: 3px;
        }

        .chat-messages:hover::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .chat-messages:hover::-webkit-scrollbar-thumb {
            background: #FFC107;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #FF9800;
        }

        .chat-message {
            display: flex;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .chat-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
        }

        .chat-message.user .chat-avatar {
            background: #333;
        }

        .chat-bubble-content {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            background: #0f0f0f;
            color: white;
            word-wrap: break-word;
        }

        .chat-message.user .chat-bubble-content {
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
        }

        .chat-message.loading-message .chat-bubble-content {
            background: #0f0f0f;
            opacity: 0.7;
            position: relative;
            overflow: hidden;
        }

        .chat-message.loading-message .chat-bubble-content::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.2), transparent);
            animation: shimmer 1.5s infinite;
        }

        .chat-input-container {
            padding: 1rem 1.5rem;
            border-top: 2px solid #333;
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            background: #0f0f0f;
            border: 2px solid #333;
            border-radius: 12px;
            color: white;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            min-height: 44px;
            max-height: 150px;
            transition: border-color 0.3s;
            resize: none;
            overflow-y: auto;
            font-family: inherit;
            line-height: 1.4;
            /* Better scrollbar styling - autohide */
            scrollbar-width: thin;
            scrollbar-color: transparent transparent;
        }

        .chat-input:hover {
            scrollbar-color: #FFC107 #0f0f0f;
        }

        .chat-input::-webkit-scrollbar {
            width: 4px;
        }

        .chat-input::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-input::-webkit-scrollbar-thumb {
            background: transparent;
            border-radius: 2px;
        }

        .chat-input:hover::-webkit-scrollbar-track {
            background: #0f0f0f;
        }

        .chat-input:hover::-webkit-scrollbar-thumb {
            background: #FFC107;
        }

        .chat-input::-webkit-scrollbar-thumb:hover {
            background: #FF9800;
        }

        .chat-input:focus {
            outline: none;
            border-color: #FFC107;
        }

        .chat-send {
            padding: 0.75rem 1.25rem;
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            height: 44px;
            align-self: flex-end;
        }

        .chat-send:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .chat-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-send.loading {
            position: relative;
            overflow: hidden;
        }

        .chat-send.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        .chat-welcome {
            text-align: center;
            color: #888;
            padding: 2rem 1rem;
        }

        .chat-welcome h4 {
            color: #e0e0e0;
            margin-bottom: 0.5rem;
        }

        /* Settings Modal */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            backdrop-filter: blur(10px);
        }

        .settings-modal.active {
            display: flex;
        }

        .settings-modal-content {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease;
        }

        .settings-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .settings-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .settings-close {
            background: none;
            border: none;
            color: #888;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .settings-close:hover {
            color: #FFC107;
            transform: scale(1.2);
        }

        .settings-option {
            padding: 1rem;
            background: #0f0f0f;
            border: 2px solid #333;
            border-radius: 12px;
            margin-bottom: 1rem;
            transition: border-color 0.3s;
        }

        .settings-option:hover {
            border-color: #444;
        }

        .settings-option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .settings-option-title {
            font-size: 1rem;
            font-weight: 600;
            color: #e0e0e0;
        }

        .settings-option-description {
            color: #888;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .settings-toggle {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .settings-toggle input[type="checkbox"] {
            display: none;
        }

        .settings-toggle-slider {
            position: relative;
            width: 48px;
            height: 26px;
            background: #333;
            border-radius: 26px;
            transition: background 0.3s;
            border: 2px solid #444;
        }

        .settings-toggle-slider::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #666;
            top: 1px;
            left: 1px;
            transition: all 0.3s;
        }

        .settings-toggle input[type="checkbox"]:checked + .settings-toggle-slider {
            background: #FFC107;
            border-color: #FFC107;
        }

        .settings-toggle input[type="checkbox"]:checked + .settings-toggle-slider::before {
            background: white;
            transform: translateX(22px);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
                padding-left: calc(1rem + 50px);
            }

            .header-logo img {
                height: 60px;
            }

            .subtitle {
                font-size: 1.5rem;
            }

            .gallery {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .button-row {
                flex-direction: column;
            }

            .describe-btn,
            .randomize-btn,
            .generate-btn-main {
                width: 100%;
            }

            .chat-modal {
                width: calc(100vw - 2rem);
                height: calc(100vh - 150px);
                right: 1rem;
                bottom: 90px;
            }

            .chat-bubble {
                bottom: 1rem;
                right: 1rem;
            }

            .history-sidebar {
                width: 50px;
            }

            .history-sidebar:hover {
                width: 280px;
            }

            .container {
                margin-left: 50px;
            }
        }
    </style>
</head>
<body>
    <div class="drag-overlay" id="dragOverlay">
        <div class="drag-overlay-content">
            <div class="drag-icon"></div>
            <h2>Drop your image here</h2>
            <p>Release to upload</p>
        </div>
    </div>

    <!-- History Sidebar -->
    <div class="history-sidebar" id="historySidebar">
        <div class="history-header">
            <div class="history-title">HISTORY</div>
        </div>
        <div class="history-items" id="historyItems">
            <div class="history-empty">
                No generations yet.<br>
                Create your first image!
            </div>
        </div>
    </div>

    <!-- Image Lightbox -->
    <div class="lightbox" id="lightbox">
        <div class="lightbox-content" id="lightboxContent">
            <button class="lightbox-close" id="lightboxClose"></button>
            <button class="lightbox-save" id="lightboxSave"> Save to Gallery</button>
            <button class="lightbox-edit" id="lightboxEdit"> Edit</button>
            <button class="lightbox-nav lightbox-prev" id="lightboxPrev"></button>
            <button class="lightbox-nav lightbox-next" id="lightboxNext"></button>
            <img class="lightbox-image" id="lightboxImage" src="" alt="Enlarged view">
            <div class="comparison-view" id="comparisonView">
                <div class="comparison-side">
                    <span class="comparison-label">Original</span>
                    <img class="comparison-image" id="originalImage" src="" alt="Original">
                </div>
                <div class="comparison-side">
                    <span class="comparison-label">Edited</span>
                    <img class="comparison-image" id="editedImage" src="" alt="Edited">
                </div>
            </div>
            <button class="comparison-close" id="comparisonClose" style="display: none;">Close Comparison</button>
            <div class="edit-interface" id="editInterface">
                <textarea 
                    id="editPrompt" 
                    class="edit-textarea"
                    placeholder="What would you like to change? (e.g., 'make it sunset', 'add snow', 'change to black and white')"
                ></textarea>
                <div class="edit-reference-section">
                    <label class="edit-reference-label">Reference Image (Optional)</label>
                    <div class="edit-reference-upload">
                        <button class="edit-upload-btn" id="editUploadBtn"> Upload Reference</button>
                        <div class="edit-reference-preview" id="editReferencePreview">
                            <img id="editReferenceImage" src="" alt="Reference">
                            <button class="edit-reference-remove" id="editReferenceRemove"></button>
                        </div>
                    </div>
                </div>
                <div class="editing-animation" id="editingAnimation">
                    <div class="editing-spinner"></div>
                    <span class="editing-text">Modifying your image...</span>
                    <span class="editing-subtext">This may take a few moments</span>
                </div>
                <div class="edit-actions">
                    <button class="edit-cancel-btn" id="editCancelBtn">Cancel</button>
                    <button class="edit-submit-btn" id="editSubmitBtn">Modify Image</button>
                </div>
            </div>
            <div class="lightbox-prompt" id="lightboxPrompt">
                <div class="prompt-bubble">
                    <span class="prompt-bubble-icon"></span>
                    <span class="prompt-bubble-text" id="promptBubbleText"></span>
                    <button class="prompt-copy-btn" id="promptCopyBtn">Copy</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Bubble -->
    <div class="chat-bubble" id="chatBubble" title="Artlist Assistant">
        
    </div>

    <!-- Quality Warning Modal -->
    <div class="quality-modal" id="qualityModal">
        <div class="quality-modal-content">
            <div class="quality-modal-icon"></div>
            <h2 class="quality-modal-title">Your prompt could be improved!</h2>
            <div class="quality-modal-score" id="qualityScore">0/10</div>
            <p class="quality-modal-message">
                Try enhancing your prompt with the "Artlist Mode" button for a more Artlist EyeCandy style prompt, or continue with your current prompt.
            </p>
            <div class="quality-modal-buttons">
                <button class="quality-modal-btn quality-modal-btn-improve" id="qualityImproveBtn">
                     Artlist Mode
                </button>
                <button class="quality-modal-btn quality-modal-btn-continue" id="qualityContinueBtn">
                    Continue Anyway
                </button>
            </div>
            <div class="quality-modal-toggle">
                <label class="toggle-container">
                    <input type="checkbox" id="disableQualityCheck">
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">Don't show this again</span>
                </label>
                <p class="toggle-hint">You can reactivate prompt check anytime in settings</p>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-modal-content">
            <div class="settings-modal-header">
                <h2 class="settings-modal-title"> Settings</h2>
                <button class="settings-close" id="settingsModalClose"></button>
            </div>
            <div class="settings-option">
                <div class="settings-option-header">
                    <div class="settings-option-title">Prompt Quality Check</div>
                    <label class="settings-toggle">
                        <input type="checkbox" id="qualityCheckToggle" checked>
                        <span class="settings-toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-option-description">
                    Check your prompt quality before generating images. Helps ensure better results with Artlist EyeCandy style prompts.
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div class="chat-modal" id="chatModal">
        <div class="chat-header">
            <h3> Artlist Assistant</h3>
            <button class="chat-close" id="chatModalClose"></button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-welcome">
                <h4> Hello!</h4>
                <p>I'm here to help you brainstorm and improve your prompts. Ask me anything!</p>
            </div>
        </div>
        <div class="chat-input-container">
            <textarea 
                id="chatInput" 
                class="chat-input" 
                placeholder="Type your message..."
                rows="1"
            ></textarea>
            <button class="chat-send" id="chatSend">Send</button>
        </div>
    </div>

    <div class="container">
        <div class="header-logo">
            <button class="settings-btn" id="settingsBtn" title="Settings"></button>
            <img src="logo/Artlist_Logo.svg.png" alt="Logo">
            <h1>
                <span class="subtitle">Prompt Journey</span>
            </h1>
        </div>

        <!-- Description Section -->
        <div class="description-section">
            <div class="prompt-area">
                <div class="prompt-header">
                    <label for="promptText">Prompt</label>
                    <div class="button-group">
                        <div class="aspect-ratio-group">
                            <label for="aspectRatio">Aspect Ratio:</label>
                            <select id="aspectRatio" class="aspect-ratio-select">
                                <option value="1:1">1:1 Square</option>
                                <option value="16:9">16:9 Landscape</option>
                                <option value="9:16">9:16 Portrait</option>
                                <option value="4:3">4:3 Standard</option>
                                <option value="3:4">3:4 Portrait</option>
                                <option value="21:9">21:9 Ultrawide</option>
                            </select>
                        </div>
                        <button class="action-btn recommend-btn" id="recommendBtn">
                            <span></span>
                            <span id="recommendText">Inspire Me</span>
                        </button>
                        <button class="action-btn improve-btn" id="improveBtn" disabled>
                            <span></span>
                            <span id="improveText">Artlist Mode</span>
                        </button>
                        <button class="action-btn copy-btn" id="copyBtn">
                            <span id="copyIcon"></span>
                            <span id="copyText">Copy</span>
                        </button>
                    </div>
                </div>
                <textarea id="promptText" placeholder="AI-generated prompts will appear here..."></textarea>
            </div>

            <div class="button-row">
                <button class="describe-btn" id="describeBtn">
                    Describe Image
                </button>
                <button class="randomize-btn" id="randomizeBtn" disabled>
                     Artlist Remix
                </button>
                <button class="generate-btn-main" id="generateBtn" disabled>
                     Generate
                </button>
            </div>

            <div class="drop-zone-hint" id="dropZoneHint">
                 Drag or click here to upload an image
            </div>

            <div class="drop-zone" id="dropZone">
                <div class="drop-instructions" id="dropInstructions">
                    <h3>Drop an image here</h3>
                    <p>or drag from gallery below, paste (Ctrl+V), or click to upload</p>
                </div>
                <div class="preview-container" id="previewContainer">
                    <img id="previewImage" alt="Preview">
                    <button class="remove-image" id="removeImage"></button>
                </div>
            </div>

            <!-- Generated Images Section -->
            <div class="generated-section" id="generatedSection">
                <h3>Generated Images</h3>
                <div class="generated-grid">
                    <div class="generated-tile" id="tile1">
                        <button class="save-to-gallery-btn" data-tile="1" title="Save to gallery"></button>
                        <div class="tile-placeholder">Image 1</div>
                        <img class="tile-image" style="display: none;">
                    </div>
                    <div class="generated-tile" id="tile2">
                        <button class="save-to-gallery-btn" data-tile="2" title="Save to gallery"></button>
                        <div class="tile-placeholder">Image 2</div>
                        <img class="tile-image" style="display: none;">
                    </div>
                    <div class="generated-tile" id="tile3">
                        <button class="save-to-gallery-btn" data-tile="3" title="Save to gallery"></button>
                        <div class="tile-placeholder">Image 3</div>
                        <img class="tile-image" style="display: none;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Gallery Section -->
        <div class="gallery-section">
            <div class="gallery-header">
                <h2>Image Gallery</h2>
                <div class="gallery-buttons">
                    <button class="save-disk-btn" id="saveDiskBtn">
                         Save to Disk
                    </button>
                    <button class="upload-btn" onclick="document.getElementById('galleryInput').click()">
                        + Add Images
                    </button>
                </div>
            </div>
            <div class="gallery" id="gallery">
                <!-- Gallery items will be added here dynamically -->
            </div>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="fileInput" accept="image/*">
    <input type="file" id="galleryInput" accept="image/*" multiple>
    <input type="file" id="editReferenceInput" accept="image/*">

    <script type="module">
        console.log(' NEW CODE VERSION LOADED - OCTOBER 22 2025 - IMPROVED ');
        
        // Import FAL client
        const falModule = await import('https://esm.sh/@fal-ai/client@1.1.0');
        const fal = falModule.fal || falModule.default || falModule;
        
        console.log('FAL library loaded:', fal);

        // Configure FAL with API key
        fal.config({
            credentials: "d11911c9-4db0-49e0-a9b1-9558d98dc26c:04fac99b361e537abbecdd98cdfd3c8e"
        });

        // Elements
        const gallery = document.getElementById('gallery');
        const dropZone = document.getElementById('dropZone');
        const dropZoneHint = document.getElementById('dropZoneHint');
        const fileInput = document.getElementById('fileInput');
        const galleryInput = document.getElementById('galleryInput');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const removeImageBtn = document.getElementById('removeImage');
        const promptText = document.getElementById('promptText');
        const describeBtn = document.getElementById('describeBtn');
        const dropInstructions = document.getElementById('dropInstructions');
        const dragOverlay = document.getElementById('dragOverlay');
        const copyBtn = document.getElementById('copyBtn');
        const copyIcon = document.getElementById('copyIcon');
        const copyText = document.getElementById('copyText');
        const generateBtn = document.getElementById('generateBtn');
        const generatedSection = document.getElementById('generatedSection');
        const recommendBtn = document.getElementById('recommendBtn');
        const recommendText = document.getElementById('recommendText');
        const lightbox = document.getElementById('lightbox');
        const lightboxContent = document.getElementById('lightboxContent');
        const lightboxImage = document.getElementById('lightboxImage');
        const lightboxClose = document.getElementById('lightboxClose');
        const lightboxSave = document.getElementById('lightboxSave');
        const lightboxEdit = document.getElementById('lightboxEdit');
        const lightboxPrev = document.getElementById('lightboxPrev');
        const lightboxNext = document.getElementById('lightboxNext');
        const editInterface = document.getElementById('editInterface');
        const editPrompt = document.getElementById('editPrompt');
        const editSubmitBtn = document.getElementById('editSubmitBtn');
        const editCancelBtn = document.getElementById('editCancelBtn');
        const editingAnimation = document.getElementById('editingAnimation');
        const comparisonView = document.getElementById('comparisonView');
        const originalImage = document.getElementById('originalImage');
        const editedImage = document.getElementById('editedImage');
        const comparisonClose = document.getElementById('comparisonClose');
        const randomizeBtn = document.getElementById('randomizeBtn');
        const improveBtn = document.getElementById('improveBtn');
        const improveText = document.getElementById('improveText');
        const tile1 = document.getElementById('tile1');
        const tile2 = document.getElementById('tile2');
        const tile3 = document.getElementById('tile3');
        const aspectRatio = document.getElementById('aspectRatio');
        const chatBubble = document.getElementById('chatBubble');
        const chatModal = document.getElementById('chatModal');
        const chatModalClose = document.getElementById('chatModalClose');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const chatSend = document.getElementById('chatSend');
        const lightboxPrompt = document.getElementById('lightboxPrompt');
        const promptBubbleText = document.getElementById('promptBubbleText');
        const promptCopyBtn = document.getElementById('promptCopyBtn');
        const historySidebar = document.getElementById('historySidebar');
        const historyItems = document.getElementById('historyItems');
        const saveDiskBtn = document.getElementById('saveDiskBtn');
        const editUploadBtn = document.getElementById('editUploadBtn');
        const editReferenceInput = document.getElementById('editReferenceInput');
        const editReferencePreview = document.getElementById('editReferencePreview');
        const editReferenceImage = document.getElementById('editReferenceImage');
        const editReferenceRemove = document.getElementById('editReferenceRemove');
        const qualityModal = document.getElementById('qualityModal');
        const qualityScore = document.getElementById('qualityScore');
        const qualityImproveBtn = document.getElementById('qualityImproveBtn');
        const qualityContinueBtn = document.getElementById('qualityContinueBtn');
        const disableQualityCheck = document.getElementById('disableQualityCheck');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const settingsModalClose = document.getElementById('settingsModalClose');
        const qualityCheckToggle = document.getElementById('qualityCheckToggle');

        let currentImageData = null;
        let lightboxImages = [];
        let currentLightboxIndex = 0;
        let chatHistory = [];
        let galleryImageData = new Map();
        let generationHistory = [];
        let editReferenceImageData = null;
        
        // Initialize quality check setting (default is TRUE/enabled)
        let qualityCheckEnabled;
        const storedValue = localStorage.getItem('qualityCheckEnabled');
        
        if (storedValue === null) {
            // First time - default to enabled
            qualityCheckEnabled = true;
            localStorage.setItem('qualityCheckEnabled', 'true');
        } else {
            // Use stored value
            qualityCheckEnabled = storedValue === 'true';
        }
        
        // Update UI elements to match the setting
        if (disableQualityCheck) {
            disableQualityCheck.checked = !qualityCheckEnabled;
        }
        if (qualityCheckToggle) {
            qualityCheckToggle.checked = qualityCheckEnabled;
        }
        
        console.log('Quality check initialized:', qualityCheckEnabled ? 'enabled' : 'disabled');
        
        // Settings modal handlers
        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        });

        settingsModalClose.addEventListener('click', () => {
            settingsModal.classList.remove('active');
            document.body.style.overflow = '';
        });

        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.remove('active');
                document.body.style.overflow = '';
            }
        });

        // Quality check toggle in settings
        qualityCheckToggle.addEventListener('change', () => {
            qualityCheckEnabled = qualityCheckToggle.checked;
            localStorage.setItem('qualityCheckEnabled', qualityCheckEnabled ? 'true' : 'false');
            console.log('Quality check', qualityCheckEnabled ? 'enabled' : 'disabled');
        });
        
        // Generate a new session ID on each page load (don't persist)
        const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
        console.log('New session started:', sessionId);

        // Function to show quality warning modal
        function showQualityWarningModal(score) {
            return new Promise((resolve) => {
                qualityScore.textContent = `${score}/10`;
                qualityModal.classList.add('active');
                document.body.style.overflow = 'hidden';

                const improveHandler = () => {
                    // Save preference if checkbox is checked
                    if (disableQualityCheck.checked) {
                        localStorage.setItem('qualityCheckEnabled', 'false');
                        qualityCheckEnabled = false;
                    }
                    qualityModal.classList.remove('active');
                    document.body.style.overflow = '';
                    qualityImproveBtn.removeEventListener('click', improveHandler);
                    qualityContinueBtn.removeEventListener('click', continueHandler);
                    resolve(false); // User chose to improve
                };

                const continueHandler = () => {
                    // Save preference if checkbox is checked
                    if (disableQualityCheck.checked) {
                        localStorage.setItem('qualityCheckEnabled', 'false');
                        qualityCheckEnabled = false;
                    }
                    qualityModal.classList.remove('active');
                    document.body.style.overflow = '';
                    qualityImproveBtn.removeEventListener('click', improveHandler);
                    qualityContinueBtn.removeEventListener('click', continueHandler);
                    resolve(true); // User chose to continue
                };

                qualityImproveBtn.addEventListener('click', improveHandler);
                qualityContinueBtn.addEventListener('click', continueHandler);
            });
        }

        // Function to update save to disk button visibility
        function updateSaveDiskButton() {
            const galleryImages = document.querySelectorAll('.gallery-item');
            if (galleryImages.length > 0) {
                saveDiskBtn.classList.add('show');
            } else {
                saveDiskBtn.classList.remove('show');
            }
        }

        // Save all gallery images to disk
        saveDiskBtn.addEventListener('click', async () => {
            const galleryImages = document.querySelectorAll('.gallery-item img');
            
            if (galleryImages.length === 0) {
                alert('No images in gallery to save');
                return;
            }

            const originalText = saveDiskBtn.innerHTML;
            saveDiskBtn.innerHTML = ' Saving...';
            saveDiskBtn.disabled = true;

            try {
                for (let i = 0; i < galleryImages.length; i++) {
                    const img = galleryImages[i];
                    
                    // Convert image to canvas and then to JPG blob
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Create a temporary image to load the source
                    const tempImg = new Image();
                    tempImg.crossOrigin = 'anonymous';
                    
                    await new Promise((resolve, reject) => {
                        tempImg.onload = resolve;
                        tempImg.onerror = reject;
                        tempImg.src = img.src;
                    });
                    
                    canvas.width = tempImg.naturalWidth;
                    canvas.height = tempImg.naturalHeight;
                    ctx.drawImage(tempImg, 0, 0);
                    
                    // Convert to JPG blob
                    const blob = await new Promise(resolve => {
                        canvas.toBlob(resolve, 'image/jpeg', 0.95);
                    });
                    
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `gallery-image-${i + 1}-${Date.now()}.jpg`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    // Small delay between downloads
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                saveDiskBtn.innerHTML = ' Saved!';
                setTimeout(() => {
                    saveDiskBtn.innerHTML = originalText;
                    saveDiskBtn.disabled = false;
                }, 2000);
            } catch (error) {
                console.error('Error saving images to disk:', error);
                alert('Failed to save some images to disk');
                saveDiskBtn.innerHTML = originalText;
                saveDiskBtn.disabled = false;
            }
        });

        // Auto-expand chat textarea
        chatInput.addEventListener('input', function() {
            this.style.height = '44px';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        // Reset height when sending message
        function resetChatInputHeight() {
            chatInput.style.height = '44px';
        }

        // Function to check and update improve button state
        function updateImproveButtonState() {
            const text = promptText.value.trim();
            const hasValidText = text && 
                text !== 'AI-generated prompts will appear here...' && 
                text !== 'Processing image...' &&
                text !== ' Generating random prompt...' &&
                text !== ' Improving prompt...' &&
                !text.startsWith('Raw API Response:') &&
                !text.startsWith('Error:');
            improveBtn.disabled = !hasValidText;
        }

        // Chat functionality
        chatBubble.addEventListener('click', () => {
            chatModal.classList.toggle('active');
            chatBubble.classList.toggle('active');
            if (chatModal.classList.contains('active')) {
                chatInput.focus();
            }
        });

        chatModalClose.addEventListener('click', () => {
            chatModal.classList.remove('active');
            chatBubble.classList.remove('active');
        });

        // Send chat message
        async function sendChatMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            addChatMessage(message, 'user');
            chatInput.value = '';
            resetChatInputHeight();

            chatSend.disabled = true;
            chatSend.classList.add('loading');
            
            // Add loading indicator
            const loadingMsg = addChatMessage('Thinking...', 'ai', true);

            try {
                chatHistory.push({ role: 'user', content: message });

                console.log('Sending to n8n webhook:', message);
                console.log('Session ID:', sessionId);
                
                // Include current prompt in context so AI can make small changes
                const currentPrompt = promptText.value.trim();
                const contextMessage = currentPrompt && 
                                      currentPrompt !== 'AI-generated prompts will appear here...' &&
                                      currentPrompt !== 'Processing image...'
                    ? `Current prompt: ${currentPrompt}\n\nUser request: ${message}`
                    : message;
                
                // Call your n8n webhook with proper body structure
                const response = await fetch('https://artlister.app.n8n.cloud/webhook/b5df1410-aefc-4afa-915e-6e9f9b3b16a6', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        chatInput: contextMessage,
                        chatHistory: chatHistory
                    })
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers.get('content-type'));
                
                if (!response.ok) {
                    throw new Error(`Webhook returned ${response.status}: ${response.statusText}`);
                }
                
                // Get response as text first to see what we're getting
                const responseText = await response.text();
                console.log('Raw response:', responseText);
                
                // Check if response is empty
                if (!responseText || responseText.trim() === '') {
                    throw new Error('Webhook returned empty response. Check n8n workflow configuration.');
                }
                
                // Remove loading message
                if (loadingMsg) {
                    loadingMsg.remove();
                }
                
                // Try to parse as JSON
                let result;
                try {
                    result = JSON.parse(responseText);
                    console.log('Parsed JSON response:', result);
                } catch (parseError) {
                    console.error('Failed to parse response as JSON:', parseError);
                    console.error('Response text:', responseText.substring(0, 500));
                    throw new Error('Webhook returned invalid JSON. Check console for details.');
                }
                
                // Handle array response (n8n sometimes returns array)
                if (Array.isArray(result) && result.length > 0) {
                    result = result[0];
                }
                
                // Check if we have an enhanced_prompt
                if (result.enhanced_prompt && result.enhanced_prompt.trim()) {
                    // Replace the prompt textarea with the enhanced prompt
                    promptText.value = result.enhanced_prompt.trim();
                    updateGenerateButtonState();
                    
                    // Show success message in chat
                    addChatMessage(' I\'ve updated your prompt! Check the main prompt area above.', 'ai');
                    
                    // If there's a follow-up question, add it too
                    if (result.follow_up_question) {
                        setTimeout(() => {
                            addChatMessage(result.follow_up_question, 'ai');
                        }, 500);
                    }
                } else if (result.is_conversational || !result.enhanced_prompt) {
                    // It's a conversational response
                    const aiResponse = result.follow_up_question || result.original_output || 'How can I help you with your prompt?';
                    addChatMessage(aiResponse, 'ai');
                } else {
                    // Fallback
                    addChatMessage('I received your message. How can I help you craft a better prompt?', 'ai');
                }
                
                // Add AI response to history
                const aiContent = result.enhanced_prompt || result.follow_up_question || result.original_output || 'responded';
                chatHistory.push({ role: 'assistant', content: aiContent });

            } catch (error) {
                console.error('Chat error:', error);
                console.error('Error stack:', error.stack);
                
                // Remove loading message on error
                if (loadingMsg) {
                    loadingMsg.remove();
                }
                
                addChatMessage(`Sorry, I encountered an error: ${error.message}. Please check the console for details.`, 'ai');
            } finally {
                chatSend.disabled = false;
                chatSend.classList.remove('loading');
            }
        }

        function addChatMessage(message, sender, isLoading = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            if (isLoading) {
                messageDiv.classList.add('loading-message');
            }
            
            const avatar = document.createElement('div');
            avatar.className = 'chat-avatar';
            avatar.textContent = sender === 'user' ? 'U' : '';
            
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble-content';
            
            // Format the message with line breaks and structure
            if (sender === 'ai' && !isLoading) {
                bubble.innerHTML = formatAIMessage(message);
            } else {
                bubble.textContent = message;
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);
            
            const welcome = chatMessages.querySelector('.chat-welcome');
            if (welcome) welcome.remove();
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return messageDiv;
        }

        // Format AI messages with proper line breaks and bullets
        function formatAIMessage(text) {
            // Replace numbered lists with proper formatting
            text = text.replace(/(\d+)\.\s/g, '<br>$1. ');
            
            // Replace bullet points
            text = text.replace(/^-\s/gm, '<br> ');
            text = text.replace(/\n-\s/g, '<br> ');
            
            // Add line breaks for better readability
            text = text.replace(/\n\n/g, '<br><br>');
            text = text.replace(/\n/g, '<br>');
            
            // Remove leading <br> if any
            text = text.replace(/^<br>/, '');
            
            return text;
        }

        chatSend.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        });

        // History management
        function addToHistory(imageUrls, prompt) {
            const timestamp = new Date();
            const historyEntry = {
                images: imageUrls,
                prompt: prompt,
                timestamp: timestamp,
                id: Date.now()
            };
            
            generationHistory.unshift(historyEntry);
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            const emptyMessage = historyItems.querySelector('.history-empty');
            
            if (generationHistory.length === 0) {
                if (!emptyMessage) {
                    historyItems.innerHTML = `
                        <div class="history-empty">
                            No generations yet.<br>
                            Create your first image!
                        </div>
                    `;
                }
                return;
            }
            
            if (emptyMessage) {
                emptyMessage.remove();
            }
            
            historyItems.innerHTML = '';
            
            generationHistory.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'history-item';
                
                const imagesGrid = document.createElement('div');
                imagesGrid.className = 'history-item-images';
                
                entry.images.forEach((imageUrl, index) => {
                    const img = document.createElement('img');
                    img.className = 'history-item-image';
                    img.src = imageUrl;
                    img.alt = `Generated image ${index + 1}`;
                    
                    // Store this history image with its prompt in galleryImageData
                    galleryImageData.set(imageUrl, entry.prompt);
                    
                    // Click to enlarge THAT specific image
                    img.addEventListener('click', (e) => {
                        e.stopPropagation();
                        console.log('History image clicked:', imageUrl);
                        console.log('Associated prompt:', entry.prompt);
                        // Open lightbox with this specific image
                        openLightboxWithSingleImage(imageUrl);
                    });
                    
                    imagesGrid.appendChild(img);
                });
                
                const promptDiv = document.createElement('div');
                promptDiv.className = 'history-item-prompt';
                promptDiv.textContent = entry.prompt;
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'history-item-time';
                timeDiv.textContent = formatTimestamp(entry.timestamp);
                
                item.appendChild(imagesGrid);
                item.appendChild(promptDiv);
                item.appendChild(timeDiv);
                
                historyItems.appendChild(item);
            });
        }

        // New function to open lightbox with a single specific image
        function openLightboxWithSingleImage(imageSrc) {
            // Find the history entry that contains this image
            const historyEntry = generationHistory.find(entry => entry.images.includes(imageSrc));
            
            if (historyEntry) {
                // Set lightboxImages to all images in this history entry
                lightboxImages = historyEntry.images;
                currentLightboxIndex = historyEntry.images.indexOf(imageSrc);
            } else {
                // Fallback to single image
                lightboxImages = [imageSrc];
                currentLightboxIndex = 0;
            }
            
            lightboxImage.src = imageSrc;
            lightbox.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Show save button for history images too
            lightboxSave.classList.add('show');
            
            // Show prompt if available
            const imagePrompt = galleryImageData.get(imageSrc);
            if (imagePrompt) {
                promptBubbleText.textContent = imagePrompt;
                lightboxPrompt.classList.add('show');
            } else {
                lightboxPrompt.classList.remove('show');
            }
            
            // Show/hide nav buttons based on number of images
            if (lightboxImages.length > 1) {
                lightboxPrev.style.display = 'flex';
                lightboxNext.style.display = 'flex';
            } else {
                lightboxPrev.style.display = 'none';
                lightboxNext.style.display = 'none';
            }
        }

        function formatTimestamp(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return date.toLocaleDateString();
        }

        // Lightbox functionality
        function openLightbox(imageSrc, imageIndex = 0) {
            lightboxImages = [];
            const generatedImageSources = [];
            
            const tiles = [tile1, tile2, tile3];
            
            tiles.forEach(tile => {
                const img = tile.querySelector('.tile-image');
                if (img.style.display !== 'none' && img.src) {
                    lightboxImages.push(img.src);
                    generatedImageSources.push(img.src);
                }
            });
            
            const galleryItems = document.querySelectorAll('.gallery-item img');
            galleryItems.forEach(img => {
                if (img.src) {
                    lightboxImages.push(img.src);
                }
            });
            
            currentLightboxIndex = lightboxImages.indexOf(imageSrc);
            if (currentLightboxIndex === -1) currentLightboxIndex = 0;
            
            lightboxImage.src = lightboxImages[currentLightboxIndex];
            lightbox.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            if (generatedImageSources.includes(lightboxImages[currentLightboxIndex])) {
                lightboxSave.classList.add('show');
            } else {
                lightboxSave.classList.remove('show');
            }
            
            updateLightboxPrompt();
            updateLightboxNav();
            
            lightbox.dataset.generatedSources = JSON.stringify(generatedImageSources);
        }

        function updateLightboxPrompt() {
            const currentImageSrc = lightboxImages[currentLightboxIndex];
            
            // Check if this is a generated image (from tiles)
            const tiles = [tile1, tile2, tile3];
            const isGeneratedImage = tiles.some(tile => {
                const img = tile.querySelector('.tile-image');
                return img.src === currentImageSrc && img.style.display !== 'none';
            });
            
            // Only show prompt for gallery/history images, not currently displayed generated images
            if (!isGeneratedImage) {
                const imagePrompt = galleryImageData.get(currentImageSrc);
                
                if (imagePrompt) {
                    promptBubbleText.textContent = imagePrompt;
                    lightboxPrompt.classList.add('show');
                } else {
                    lightboxPrompt.classList.remove('show');
                }
            } else {
                lightboxPrompt.classList.remove('show');
            }
        }

        promptCopyBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const promptText = promptBubbleText.textContent;
            
            try {
                await navigator.clipboard.writeText(promptText);
                const originalText = promptCopyBtn.textContent;
                promptCopyBtn.textContent = 'Copied!';
                promptCopyBtn.classList.add('copied');
                
                setTimeout(() => {
                    promptCopyBtn.textContent = originalText;
                    promptCopyBtn.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy prompt:', err);
            }
        });

        function closeLightbox() {
            lightbox.classList.remove('active');
            lightboxContent.classList.remove('editing');
            lightboxSave.classList.remove('show');
            editInterface.classList.remove('active');
            editingAnimation.classList.remove('active');
            comparisonView.classList.remove('active');
            comparisonClose.style.display = 'none';
            lightboxImage.style.display = 'block';
            editPrompt.value = '';
            document.body.style.overflow = '';
            lightboxImages = [];
        }

        function updateLightboxNav() {
            if (lightboxImages.length <= 1) {
                lightboxPrev.style.display = 'none';
                lightboxNext.style.display = 'none';
            } else {
                lightboxPrev.style.display = 'flex';
                lightboxNext.style.display = 'flex';
            }
        }

        function showPrevImage() {
            if (lightboxImages.length <= 1) return;
            currentLightboxIndex = (currentLightboxIndex - 1 + lightboxImages.length) % lightboxImages.length;
            lightboxImage.src = lightboxImages[currentLightboxIndex];
            updateSaveButtonVisibility();
            updateLightboxPrompt();
        }

        function showNextImage() {
            if (lightboxImages.length <= 1) return;
            currentLightboxIndex = (currentLightboxIndex + 1) % lightboxImages.length;
            lightboxImage.src = lightboxImages[currentLightboxIndex];
            updateSaveButtonVisibility();
            updateLightboxPrompt();
        }

        function updateSaveButtonVisibility() {
            const generatedSources = JSON.parse(lightbox.dataset.generatedSources || '[]');
            if (generatedSources.includes(lightboxImages[currentLightboxIndex])) {
                lightboxSave.classList.add('show');
            } else {
                lightboxSave.classList.remove('show');
            }
        }

        lightboxClose.addEventListener('click', (e) => {
            e.stopPropagation();
            closeLightbox();
        });

        lightboxPrev.addEventListener('click', (e) => {
            e.stopPropagation();
            showPrevImage();
        });

        lightboxNext.addEventListener('click', (e) => {
            e.stopPropagation();
            showNextImage();
        });

        // Save to gallery (no disk save)
        lightboxSave.addEventListener('click', async (e) => {
            e.stopPropagation();
            const currentImageUrl = lightboxImages[currentLightboxIndex];
            
            try {
                const response = await fetch(currentImageUrl);
                const blob = await response.blob();
                const file = new File([blob], 'generated-image.png', { type: blob.type });
                const currentPrompt = promptText.value.trim();
                
                // Just add to gallery, no disk save
                addToGallery(file, currentPrompt);
                
                const originalText = lightboxSave.innerHTML;
                lightboxSave.innerHTML = ' Saved!';
                setTimeout(() => {
                    lightboxSave.innerHTML = originalText;
                }, 1500);
            } catch (error) {
                console.error('Error saving to gallery:', error);
                alert('Failed to save image to gallery');
            }
        });

        // Edit Image functionality
        console.log('Setting up edit functionality, lightboxEdit:', lightboxEdit);
        
        lightboxEdit.addEventListener('click', (e) => {
            console.log('Edit button clicked!');
            e.stopPropagation();
            lightboxContent.classList.add('editing');
            editInterface.classList.add('active');
            editPrompt.focus();
        });

        editCancelBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            lightboxContent.classList.remove('editing');
            editInterface.classList.remove('active');
            editPrompt.value = '';
            // Clear reference image
            editReferenceImageData = null;
            editReferencePreview.classList.remove('show');
            editReferenceImage.src = '';
        });

        // Reference image upload handlers
        editUploadBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            editReferenceInput.click();
        });

        editReferenceInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    editReferenceImageData = e.target.result;
                    editReferenceImage.src = e.target.result;
                    editReferencePreview.classList.add('show');
                };
                reader.readAsDataURL(file);
            }
        });

        editReferenceRemove.addEventListener('click', (e) => {
            e.stopPropagation();
            editReferenceImageData = null;
            editReferencePreview.classList.remove('show');
            editReferenceImage.src = '';
            editReferenceInput.value = '';
        });

        comparisonClose.addEventListener('click', (e) => {
            e.stopPropagation();
            comparisonView.classList.remove('active');
            comparisonClose.style.display = 'none';
            lightboxImage.style.display = 'block';
            lightboxImage.src = lightboxImages[currentLightboxIndex];
        });

        editSubmitBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const prompt = editPrompt.value.trim();
            const currentImageUrl = lightboxImages[currentLightboxIndex];
            
            if (!prompt || !currentImageUrl) return;

            try {
                // Store original image for comparison
                const originalImageUrl = currentImageUrl;
                
                // Hide edit interface and show editing animation
                editInterface.classList.remove('active');
                editingAnimation.classList.add('active');

                console.log('=== EDIT IMAGE CLICKED ===');
                console.log('Image URL:', currentImageUrl);
                console.log('Edit prompt:', prompt);
                console.log('Reference image:', editReferenceImageData ? 'Yes' : 'No');

                // Upload main image to fal if it's a local data URL
                let imageUrl = currentImageUrl;
                if (currentImageUrl.startsWith('data:') || currentImageUrl.startsWith('blob:')) {
                    console.log('Converting data URL to blob...');
                    const response = await fetch(currentImageUrl);
                    const blob = await response.blob();
                    const file = new File([blob], 'image.jpg', { type: blob.type });
                    
                    console.log('Uploading main image to FAL...');
                    imageUrl = await fal.storage.upload(file);
                    console.log(' Main image uploaded:', imageUrl);
                }

                // Prepare image URLs array
                const imageUrls = [imageUrl];

                // Upload reference image if provided
                if (editReferenceImageData) {
                    console.log('Converting reference image to blob...');
                    const refResponse = await fetch(editReferenceImageData);
                    const refBlob = await refResponse.blob();
                    const refFile = new File([refBlob], 'reference.jpg', { type: refBlob.type });
                    
                    console.log('Uploading reference image to FAL...');
                    const refImageUrl = await fal.storage.upload(refFile);
                    console.log(' Reference image uploaded:', refImageUrl);
                    imageUrls.push(refImageUrl);
                }

                // Call the edit workflow
                console.log('Starting edit workflow...');
                console.log('Image URLs:', imageUrls);
                const stream = await fal.stream("workflows/Content-vlm7ci7l2p91/colby-image-edit-by-prompt", {
                    input: {
                        image_urls: imageUrls,
                        prompt: prompt
                    }
                });

                console.log('Stream created, consuming events...');
                for await (const event of stream) {
                    console.log('Edit stream event:', event);
                }

                const result = await stream.done();
                console.log(' Edit complete:', JSON.stringify(result, null, 2));

                // Hide editing animation
                editingAnimation.classList.remove('active');

                // Extract the edited image URL from the result
                let editedImageUrl = null;
                if (result?.output?.image?.url) {
                    editedImageUrl = result.output.image.url;
                } else if (result?.output?.images && Array.isArray(result.output.images) && result.output.images.length > 0) {
                    const imageField = result.output.images[0];
                    editedImageUrl = typeof imageField === 'object' ? imageField.url : imageField;
                } else if (result?.image?.url) {
                    editedImageUrl = result.image.url;
                }

                if (editedImageUrl) {
                    console.log(' Edited image URL:', editedImageUrl);
                    
                    // Update the lightbox with the edited image
                    lightboxImages[currentLightboxIndex] = editedImageUrl;
                    
                    // Mark as generated so save button appears
                    const generatedSources = JSON.parse(lightbox.dataset.generatedSources || '[]');
                    if (!generatedSources.includes(editedImageUrl)) {
                        generatedSources.push(editedImageUrl);
                        lightbox.dataset.generatedSources = JSON.stringify(generatedSources);
                    }
                    updateSaveButtonVisibility();
                    
                    // Automatically save edited image to gallery
                    try {
                        const response = await fetch(editedImageUrl);
                        const blob = await response.blob();
                        const file = new File([blob], 'edited-image.png', { type: blob.type });
                        const editDescription = `Edited: ${prompt}`;
                        addToGallery(file, editDescription);
                        console.log(' Edited image automatically saved to gallery');
                        // Save to Supabase
await saveToSupabase(
    { prompt: prompt, original_image: originalImageUrl },
    { workflow: 'image-edit-by-prompt' },
    [editedImageUrl],
    'image-edit'
);
                    } catch (error) {
                        console.error('Error auto-saving to gallery:', error);
                    }
                    
                    // Show side-by-side comparison
                    lightboxImage.style.display = 'none';
                    originalImage.src = originalImageUrl;
                    editedImage.src = editedImageUrl;
                    comparisonView.classList.add('active');
                    comparisonClose.style.display = 'block';
                    
                    // Clear the edit prompt and reference image, exit edit mode
                    editPrompt.value = '';
                    editReferenceImageData = null;
                    editReferencePreview.classList.remove('show');
                    editReferenceImage.src = '';
                    editReferenceInput.value = '';
                    lightboxContent.classList.remove('editing');
                } else {
                    throw new Error('No edited image found in response');
                }

            } catch (error) {
                console.error(' Error editing image:', error);
                console.error(' Error stack:', error.stack);
                editingAnimation.classList.remove('active');
                editInterface.classList.add('active');
                alert(`Failed to edit image: ${error.message}\n\nCheck console for details.`);
            }
        });

        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox) {
                closeLightbox();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (lightbox.classList.contains('active')) {
                if (e.key === 'Escape') {
                    closeLightbox();
                } else if (e.key === 'ArrowLeft') {
                    showPrevImage();
                } else if (e.key === 'ArrowRight') {
                    showNextImage();
                }
            }
        });

        // Recommend prompt functionality
        recommendBtn.addEventListener('click', async () => {
            console.log('=== RANDOM PROMPT CLICKED ===');
            const currentText = promptText.value.trim();
            
            const hasText = currentText && 
                currentText !== 'AI-generated prompts will appear here...' && 
                currentText !== 'Processing image...' &&
                currentText !== ' Generating random prompt...' &&
                currentText !== ' Improving prompt...' &&
                !currentText.startsWith('Raw API Response:') &&
                !currentText.startsWith('Error:');

            recommendBtn.disabled = true;
            recommendBtn.classList.add('loading');
            recommendText.textContent = 'Generating...';
            
            promptText.value = ' Generating random prompt...';
            
            try {
                console.log('Calling n8n webhook for random prompt...');
                
                const payload = hasText ? { prompt: currentText } : {};
                console.log('Payload:', payload);
                
                const response = await fetch('https://artlister.app.n8n.cloud/webhook/prompt-recommend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`Webhook returned ${response.status}: ${response.statusText}`);
                }
                
                const responseClone = response.clone();
                
                let result;
                const contentType = response.headers.get('content-type');
                console.log('Response content-type:', contentType);
                
                try {
                    result = await response.json();
                    console.log(' Recommendation result (JSON):', result);
                } catch (e) {
                    result = await responseClone.text();
                    console.log(' Recommendation result (text):', result);
                }
                
                let recommendation = '';
                if (typeof result === 'string') {
                    recommendation = result;
                } else if (result.prompt) {
                    recommendation = result.prompt;
                } else if (result.recommendation) {
                    recommendation = result.recommendation;
                } else if (result.output) {
                    recommendation = result.output;
                } else if (result.text) {
                    recommendation = result.text;
                } else if (result.message) {
                    recommendation = result.message;
                } else {
                    recommendation = JSON.stringify(result, null, 2);
                }
                
                if (recommendation) {
                    promptText.value = recommendation;
                    updateGenerateButtonState();
                    console.log(' Recommendation displayed');
                } else {
                    console.warn(' No recommendation text found in response');
                    promptText.value = 'Webhook Response:\n' + JSON.stringify(result, null, 2);
                }
                
            } catch (error) {
                console.error(' Recommendation error:', error);
                alert(`Failed to get recommendation: ${error.message}\n\nMake sure your n8n workflow is active and the webhook is configured correctly.`);
                promptText.value = 'AI-generated prompts will appear here...';
            } finally {
                recommendBtn.disabled = false;
                recommendBtn.classList.remove('loading');
                recommendText.textContent = 'Inspire Me';
            }
        });

        // Improve Prompt functionality (Artlist Mode)
        improveBtn.addEventListener('click', async () => {
            console.log('=== ARTLIST MODE CLICKED ===');
            const currentText = promptText.value.trim();
            
            if (!currentText || 
                currentText === 'AI-generated prompts will appear here...' || 
                currentText === 'Processing image...' ||
                currentText === ' Generating random prompt...' ||
                currentText === ' Enhancing prompt...' ||
                currentText.startsWith('Raw API Response:') ||
                currentText.startsWith('Error:')) {
                return;
            }

            improveBtn.disabled = true;
            improveBtn.classList.add('loading');
            improveText.textContent = 'Enhancing...';
            
            const originalPrompt = currentText;
            promptText.value = ' Enhancing prompt...';
            
            try {
                console.log('Calling FAL workflow for prompt enhancement...');
                console.log('Original prompt:', originalPrompt);
                
                const workflowId = "workflows/Content-vlm7ci7l2p91/colby-promptenhancer";
                const workflowInput = {
                    prompt: originalPrompt
                };
                
                console.log('Workflow:', workflowId);
                console.log('Input:', workflowInput);
                
                const stream = await fal.stream(workflowId, {
                    input: workflowInput
                });

                console.log('Stream created, consuming events...');
                
                for await (const event of stream) {
                    console.log('Stream event:', event);
                }

                const result = await stream.done();
                console.log(' Final result:', JSON.stringify(result, null, 2));
                
                let improvedPrompt = '';
                if (result && typeof result === 'object') {
                    if (result.output?.output) {
                        improvedPrompt = result.output.output;
                    } else if (result.output && typeof result.output === 'string') {
                        improvedPrompt = result.output;
                    } else if (result.text) {
                        improvedPrompt = result.text;
                    } else if (result.prompt) {
                        improvedPrompt = result.prompt;
                    } else if (result.enhanced_prompt) {
                        improvedPrompt = result.enhanced_prompt;
                    } else if (result.improved_prompt) {
                        improvedPrompt = result.improved_prompt;
                    } else if (typeof result.output === 'string') {
                        improvedPrompt = result.output;
                    } else if (result.data?.text) {
                        improvedPrompt = result.data.text;
                    } else if (result.data?.prompt) {
                        improvedPrompt = result.data.prompt;
                    }
                    
                    if (improvedPrompt) {
                        improvedPrompt = improvedPrompt.replace(/<think>[\s\S]*?<\/think>/g, '').trim();
                    }
                    
                    if (!improvedPrompt) {
                        console.warn(' Could not find improved prompt in expected fields, showing raw result');
                        improvedPrompt = 'Raw API Response:\n' + JSON.stringify(result, null, 2);
                    }
                }
                
                promptText.value = improvedPrompt || originalPrompt;
                console.log(' Improved prompt displayed');
                
                updateGenerateButtonState();
                
            } catch (error) {
                console.error(' Error improving prompt:', error);
                console.error(' Error stack:', error.stack);
                promptText.value = originalPrompt;
                alert(`Failed to improve prompt: ${error.message}\n\nCheck console for details.`);
            } finally {
                improveBtn.disabled = false;
                improveBtn.classList.remove('loading');
                improveText.textContent = 'Artlist Mode';
                updateImproveButtonState();
            }
        });

        // Save to gallery functionality
        document.querySelectorAll('.save-to-gallery-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.stopPropagation();
                
                const tileNumber = btn.dataset.tile;
                const tile = document.getElementById(`tile${tileNumber}`);
                const img = tile.querySelector('.tile-image');
                
                if (!img.src || img.style.display === 'none') {
                    return;
                }
                
                try {
                    const response = await fetch(img.src);
                    const blob = await response.blob();
                    const file = new File([blob], `generated-${Date.now()}.jpg`, { type: blob.type });
                    const currentPrompt = promptText.value.trim();
                    
                    // Just add to gallery, no disk save
                    addToGallery(file, currentPrompt);
                    
                    btn.classList.add('saved');
                    btn.textContent = '';
                    
                    setTimeout(() => {
                        btn.classList.remove('saved');
                        btn.textContent = '';
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error saving to gallery:', error);
                    alert('Failed to save image to gallery. The image may not allow cross-origin access.');
                }
            });
        });

        function updateGenerateButtonState() {
            const text = promptText.value.trim();
            const hasValidText = text && 
                text !== 'AI-generated prompts will appear here...' && 
                text !== 'Processing image...' &&
                text !== ' Generating random prompt...' &&
                text !== ' Enhancing prompt...' &&
                !text.startsWith('Raw API Response:') &&
                !text.startsWith('Error:');
            generateBtn.disabled = !hasValidText;
            improveBtn.disabled = !hasValidText;
        }

        promptText.addEventListener('input', updateGenerateButtonState);

        // Generate button functionality
        generateBtn.addEventListener('click', async () => {
            const currentText = promptText.value.trim();
            
            if (!currentText) {
                alert('Please describe an image first before generating.');
                return;
            }

            // First, check the prompt quality (only if enabled)
            if (qualityCheckEnabled) {
                try {
                    console.log('=== PROMPT QUALITY CHECK ===');
                    console.log('Checking prompt quality for:', currentText);
                    
                    const requestBody = { prompt: currentText };
                    console.log('Request body:', requestBody);
                    
                    const qualityResponse = await fetch('https://artlister.app.n8n.cloud/webhook/e80ce35d-99df-4234-a154-78e3b8fca1e1', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });

                    console.log('Response status:', qualityResponse.status);
                
                if (!qualityResponse.ok) {
                    throw new Error(`Quality check failed: ${qualityResponse.status}`);
                }

                const qualityResult = await qualityResponse.json();
                console.log(' Quality check result:', qualityResult);

                let score = 10; // Default to high score if parsing fails
                
                // Parse the score from the response
                if (Array.isArray(qualityResult) && qualityResult.length > 0) {
                    // Check if the array contains objects with score property directly
                    if (qualityResult[0].score !== undefined) {
                        score = qualityResult[0].score;
                        console.log('Score from array[0].score:', score);
                    } else {
                        // Otherwise check for output property
                        const output = qualityResult[0].output;
                        console.log('Parsing output:', output);
                        if (typeof output === 'string') {
                            try {
                                const parsed = JSON.parse(output);
                                score = parsed.score || 10;
                                console.log('Parsed score from string:', score);
                            } catch (e) {
                                console.warn('Could not parse score from output:', output);
                            }
                        } else if (typeof output === 'object' && output.score !== undefined) {
                            score = output.score;
                            console.log('Score from output object:', score);
                        }
                    }
                } else if (qualityResult.score !== undefined) {
                    score = qualityResult.score;
                    console.log('Direct score:', score);
                }

                console.log('Final prompt quality score:', score);

                // If score is below 7, show custom warning modal
                if (score < 7) {
                    const userChoice = await showQualityWarningModal(score);

                    if (!userChoice) {
                        // User chose to cancel and improve prompt
                        console.log('User chose to improve prompt first');
                        return;
                    }
                    // User chose to continue anyway
                    console.log(' User chose to continue with current prompt despite low score');
                }

                } catch (error) {
                    console.warn(' Prompt quality check unavailable');
                    console.warn('Error details:', error);
                    console.log(' Proceeding with generation (quality check is optional)');
                }
            } else {
                console.log('Quality check is disabled by user preference');
            }

            // Proceed with generation
            generateBtn.disabled = true;
            generateBtn.classList.add('loading');
            generateBtn.textContent = 'Generating...';
            
            generatedSection.classList.add('active');
            const tiles = [tile1, tile2, tile3];
            
            tiles.forEach((tile, index) => {
                tile.classList.add('loading');
                tile.classList.remove('has-image');
                const placeholder = tile.querySelector('.tile-placeholder');
                placeholder.textContent = `Generating ${index + 1}`;
                placeholder.style.display = 'block';
                const img = tile.querySelector('.tile-image');
                img.style.display = 'none';
            });

            try {
                console.log('Starting generate workflow...');
                console.log('Input prompt:', currentText);
                console.log('Aspect ratio:', aspectRatio.value);
                
                const stream = await fal.stream("workflows/Content-vlm7ci7l2p91/surprise-me-text", {
                    input: {
                        user_prompt: currentText
                    }
                });

                console.log('Generate stream created, consuming events...');
                
                for await (const event of stream) {
                    console.log('Generate stream event:', event);
                }

                const result = await stream.done();
                console.log(' Generate result:', JSON.stringify(result, null, 2));
                
                let images = [];
                if (result && typeof result === 'object') {
                    if (result.output) {
                        const output = result.output;
                        
                        if (output.images && Array.isArray(output.images) && output.images[0]) {
                            images.push(output.images[0]);
                        }
                        if (output.images_2 && Array.isArray(output.images_2) && output.images_2[0]) {
                            images.push(output.images_2[0]);
                        }
                        if (output.images_3 && Array.isArray(output.images_3) && output.images_3[0]) {
                            images.push(output.images_3[0]);
                        }
                    }
                    
                    if (images.length === 0) {
                        if (result.images && Array.isArray(result.images)) {
                            images = result.images;
                        } else if (result.data?.images && Array.isArray(result.data.images)) {
                            images = result.data.images;
                        } else if (Array.isArray(result.output)) {
                            images = result.output;
                        } else if (Array.isArray(result)) {
                            images = result;
                        }
                    }
                }
                
                console.log('Extracted images:', images);
                
                if (images.length > 0) {
                    const generatedImageUrls = [];
                    
                    images.slice(0, 3).forEach((imageData, index) => {
                        const tile = tiles[index];
                        const img = tile.querySelector('.tile-image');
                        const placeholder = tile.querySelector('.tile-placeholder');
                        
                        let imageUrl = '';
                        if (typeof imageData === 'string') {
                            imageUrl = imageData;
                        } else if (imageData.url) {
                            imageUrl = imageData.url;
                        } else if (imageData.image_url) {
                            imageUrl = imageData.image_url;
                        }
                        
                        if (imageUrl) {
                            generatedImageUrls.push(imageUrl);
                            
                            galleryImageData.set(imageUrl, currentText);
                            
                            img.src = imageUrl;
                            img.style.display = 'block';
                            placeholder.style.display = 'none';
                            tile.classList.remove('loading');
                            tile.classList.add('has-image');
                            
                            tile.draggable = true;
                            
                            tile.ondragstart = null;
                            
                            tile.addEventListener('dragstart', (e) => {
                                e.dataTransfer.effectAllowed = 'copy';
                                e.dataTransfer.setData('text/uri-list', imageUrl);
                                e.dataTransfer.setData('text/plain', imageUrl);
                                console.log('Dragging generated image:', imageUrl);
                            });
                            
                            img.onclick = (e) => {
                                e.stopPropagation();
                                openLightbox(img.src);
                            };
                        }
                    });
                    
                    if (generatedImageUrls.length > 0) {
                        addToHistory(generatedImageUrls, currentText);
                    }
                    
                    console.log(' Images displayed');
                    // Save each image to Supabase separately
                    if (generatedImageUrls.length > 0) {
                        for (const imageUrl of generatedImageUrls) {
                            await saveToSupabase(
                                { prompt: currentText },
                                { workflow: 'text-to-image-generation' },
                                [imageUrl],  // Single image in array
                                'text-to-image'
                            );
                        }
                    }
                } else {
                    console.warn(' No images found in result');
                    alert('No images were generated. Check console for details.');
                    tiles.forEach(tile => {
                        tile.classList.remove('loading');
                        tile.querySelector('.tile-placeholder').textContent = 'No image';
                    });
                }
                
            } catch (error) {
                console.error(' Generate error:', error);
                alert(`Generate failed: ${error.message}\n\nThe workflow may not be published yet.`);
                tiles.forEach(tile => {
                    tile.classList.remove('loading');
                    tile.querySelector('.tile-placeholder').textContent = 'Error';
                });
            } finally {
                generateBtn.disabled = false;
                generateBtn.classList.remove('loading');
                generateBtn.textContent = ' Generate';
            }
        });

        // Copy button functionality
        copyBtn.addEventListener('click', async () => {
            const text = promptText.value;
            if (!text || text === 'The AI-generated description will appear here...' || text === 'Processing image...') {
                return;
            }

            try {
                await navigator.clipboard.writeText(text);
                copyBtn.classList.add('copied');
                copyIcon.textContent = '';
                copyText.textContent = 'Copied!';
                
                setTimeout(() => {
                    copyBtn.classList.remove('copied');
                    copyIcon.textContent = '';
                    copyText.textContent = 'Copy';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
                promptText.select();
                document.execCommand('copy');
                copyBtn.classList.add('copied');
                copyIcon.textContent = '';
                copyText.textContent = 'Copied!';
                
                setTimeout(() => {
                    copyBtn.classList.remove('copied');
                    copyIcon.textContent = '';
                    copyText.textContent = 'Copy';
                }, 2000);
            }
        });

        // Gallery upload
        galleryInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    addToGallery(file);
                }
            });
        });

        // Add image to gallery
        function addToGallery(file, prompt = '') {
            const reader = new FileReader();
            reader.onload = (e) => {
                const item = document.createElement('div');
                item.className = 'gallery-item';
                item.draggable = true;
                
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = file.name;
                
                if (prompt) {
                    galleryImageData.set(img.src, prompt);
                }
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'gallery-item-delete';
                deleteBtn.innerHTML = '';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    galleryImageData.delete(img.src);
                    item.remove();
                    updateSaveDiskButton(); // Update button visibility after delete
                };
                
                item.appendChild(img);
                item.appendChild(deleteBtn);
                gallery.appendChild(item);

                img.addEventListener('click', (e) => {
                    if (e.target === img) {
                        openLightbox(img.src);
                    }
                });

                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'copy';
                    e.dataTransfer.setData('text/uri-list', img.src);
                    e.dataTransfer.setData('text/plain', img.src);
                });
                
                updateSaveDiskButton(); // Update button visibility after add
            };
            reader.readAsDataURL(file);
        }

        // Drop zone click
        dropZone.addEventListener('click', (e) => {
            if (e.target === dropZone || e.target === dropInstructions || e.target.parentElement === dropInstructions) {
                fileInput.click();
            }
        });

        dropZoneHint.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                loadImage(file);
            }
        });

        // Drag and drop
        let dragCounter = 0;

        document.addEventListener('dragenter', (e) => {
            e.preventDefault();
            dragCounter++;
            if (e.dataTransfer.types.includes('Files') || e.dataTransfer.types.includes('text/uri-list')) {
                dragOverlay.classList.add('show');
                dropZone.classList.add('dragging-over-page');
            }
        });

        document.addEventListener('dragleave', (e) => {
            dragCounter--;
            if (dragCounter === 0) {
                dragOverlay.classList.remove('show');
                dropZone.classList.remove('dragging-over-page');
            }
        });

        document.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            dragCounter = 0;
            dragOverlay.classList.remove('show');
            dropZone.classList.remove('dragging-over-page');
            
            if (dropZone.contains(e.target)) {
                handleDrop(e);
            } else {
                handleDrop(e);
            }
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('drag-over');
        });

        function handleDrop(e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    loadImage(file);
                }
            } else {
                const uri = e.dataTransfer.getData('text/uri-list') || e.dataTransfer.getData('text/plain');
                if (uri) {
                    if (uri.startsWith('data:image')) {
                        currentImageData = uri;
                        displayImage(uri);
                    } else if (uri.startsWith('http')) {
                        fetch(uri)
                            .then(response => response.blob())
                            .then(blob => {
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    currentImageData = e.target.result;
                                    displayImage(e.target.result);
                                };
                                reader.readAsDataURL(blob);
                            })
                            .catch(err => {
                                console.error('Error loading remote image:', err);
                                alert('Failed to load image. It may not allow cross-origin loading.');
                            });
                    }
                }
            }
        }

        // Paste handling
        document.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (let item of items) {
                if (item.type.startsWith('image/')) {
                    const file = item.getAsFile();
                    loadImage(file);
                    break;
                }
            }
        });

        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                currentImageData = e.target.result;
                displayImage(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function displayImage(src) {
            previewImage.src = src;
            previewContainer.style.display = 'block';
            dropInstructions.style.display = 'none';
            dropZone.classList.add('has-image');
            dropZoneHint.classList.add('hidden');
            describeBtn.disabled = false;
            randomizeBtn.disabled = false;
        }

        removeImageBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            currentImageData = null;
            previewContainer.style.display = 'none';
            dropInstructions.style.display = 'block';
            dropZone.classList.remove('has-image');
            dropZoneHint.classList.remove('hidden');
            describeBtn.disabled = true;
            randomizeBtn.disabled = true;
        });

        // Describe button click
        describeBtn.addEventListener('click', async () => {
            if (!currentImageData) return;

            describeBtn.disabled = true;
            describeBtn.classList.add('loading');
            describeBtn.textContent = 'Analyzing...';
            promptText.value = 'Processing image...';

            try {
                const base64Response = await fetch(currentImageData);
                const blob = await base64Response.blob();
                
                const file = new File([blob], 'image.jpg', { type: blob.type });
                
                console.log('Uploading image to FAL...');
                const imageUrl = await fal.storage.upload(file);
                console.log(' Image uploaded:', imageUrl);
                
                console.log('Starting workflow stream...');
                
                const workflowInput = {
                    image_url: imageUrl
                };
                
                const workflowId = "workflows/Content-vlm7ci7l2p91/colbyimagedescribe";
                console.log('Workflow:', workflowId);
                console.log('Input:', workflowInput);
                
                const stream = await fal.stream(workflowId, {
                    input: workflowInput
                });

                console.log('Stream created, consuming events...');
                
                for await (const event of stream) {
                    console.log('Stream event:', event);
                }

                const result = await stream.done();
                console.log(' Final result:', JSON.stringify(result, null, 2));
                
                let description = '';
                if (result && typeof result === 'object') {
                    if (result.output?.output) {
                        description = result.output.output;
                    } else if (result.output && typeof result.output === 'string') {
                        description = result.output;
                    } else if (result.text) {
                        description = result.text;
                    } else if (result.description) {
                        description = result.description;
                    } else if (typeof result.output === 'string') {
                        description = result.output;
                    } else if (result.data?.text) {
                        description = result.data.text;
                    } else if (result.data?.description) {
                        description = result.data.description;
                    }
                    
                    if (description) {
                        description = description.replace(/<think>[\s\S]*?<\/think>/g, '').trim();
                    }
                    
                    if (!description) {
                        console.warn(' Could not find description in expected fields, showing raw result');
                        description = 'Raw API Response:\n' + JSON.stringify(result, null, 2);
                    }
                }
                
                promptText.value = description || 'No description generated.';
                console.log(' Description displayed');
                
                updateGenerateButtonState();
                
            } catch (error) {
                console.error(' Error details:', error);
                console.error(' Error stack:', error.stack);
                promptText.value = `Error: ${error.message || 'Failed to generate description'}\n\nCheck console for details.`;
            } finally {
                describeBtn.disabled = false;
                describeBtn.classList.remove('loading');
                describeBtn.textContent = 'Describe Image';
            }
        });

        // Load sample images from /samples/ folder
        const sampleImages = [
            'image1.jpg',
            'image2.jpg',
            'image3.jpg',
            'image4.jpg',
            'image5.jpg',
            'image6.jpg',
            'image7.jpg',
            'image8.jpg',
            'image9.jpg',
            'image10.jpg',
            'image11.jpg',
            'image12.jpg'
        ];

        function loadSampleImages() {
            sampleImages.forEach((filename, index) => {
                const item = document.createElement('div');
                item.className = 'gallery-item';
                item.draggable = true;
                
                const img = document.createElement('img');
                img.src = `samples/${filename}`;
                img.alt = `Sample ${index + 1}`;
                
                img.onerror = () => {
                    item.remove();
                    updateSaveDiskButton(); // Update after failed load
                };
                
                img.onload = () => {
                    updateSaveDiskButton(); // Update after successful load
                };
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'gallery-item-delete';
                deleteBtn.innerHTML = '';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    item.remove();
                    updateSaveDiskButton(); // Update after delete
                };
                
                item.appendChild(img);
                item.appendChild(deleteBtn);
                gallery.appendChild(item);

                img.addEventListener('click', (e) => {
                    if (e.target === img) {
                        openLightbox(img.src);
                    }
                });

                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'copy';
                    e.dataTransfer.setData('text/uri-list', img.src);
                    e.dataTransfer.setData('text/plain', img.src);
                });
            });
        }

        describeBtn.disabled = true;
        randomizeBtn.disabled = true;
        improveBtn.disabled = true;
        loadSampleImages();
        updateSaveDiskButton(); // Check if we should show the button after loading samples

        [tile1, tile2, tile3].forEach(tile => {
            tile.addEventListener('click', (e) => {
                if (e.target.classList.contains('save-to-gallery-btn')) {
                    return;
                }
                
                const img = tile.querySelector('.tile-image');
                if (img && img.style.display !== 'none' && img.src) {
                    openLightbox(img.src);
                }
            });
        });

        // Artlist Remix - Generate 3 variations with randomized angles and actions
        randomizeBtn.addEventListener('click', async () => {
            if (!currentImageData) return;
            
            console.log('=== ARTLIST REMIX CLICKED ===');
            
            randomizeBtn.disabled = true;
            randomizeBtn.classList.add('loading');
            const originalText = randomizeBtn.textContent;
            randomizeBtn.textContent = ' Remixing...';
            
            try {
                const base64Response = await fetch(currentImageData);
                const blob = await base64Response.blob();
                
                const file = new File([blob], 'image.jpg', { type: blob.type });
                
                console.log('Uploading image to FAL...');
                const imageUrl = await fal.storage.upload(file);
                console.log(' Image uploaded:', imageUrl);
                
                [tile1, tile2, tile3].forEach(tile => {
                    const img = tile.querySelector('.tile-image');
                    const placeholder = tile.querySelector('.tile-placeholder');
                    img.style.display = 'none';
                    img.src = '';
                    placeholder.style.display = 'flex';
                    placeholder.textContent = 'Generating';
                    tile.classList.add('loading');
                    tile.classList.remove('has-image');
                    tile.draggable = false;
                });
                
                generatedSection.style.display = 'block';
                
                console.log('Starting surprise-me workflow to generate 3 variations...');
                
                const workflowId = "workflows/Content-vlm7ci7l2p91/surprise-me-image";
                const workflowInput = {
                    image_url_field: imageUrl
                };
                
                console.log('Workflow:', workflowId);
                console.log('Input:', workflowInput);
                
                const tiles = [tile1, tile2, tile3];
                
                const stream = await fal.stream(workflowId, {
                    input: workflowInput
                });

                console.log('Stream created, consuming events...');
                
                for await (const event of stream) {
                    console.log('Stream event:', event);
                }

                const result = await stream.done();
                console.log(' Final result:', JSON.stringify(result, null, 2));
                
                const generatedImages = [];
                const currentPrompt = promptText.value.trim() || 'Image variation';
                
                if (result && typeof result === 'object' && result.output) {
                    const imageArrays = [
                        result.output.images,
                        result.output.images_2,
                        result.output.images_3
                    ];
                    
                    imageArrays.forEach((imageArray, index) => {
                        if (imageArray && Array.isArray(imageArray) && imageArray.length > 0) {
                            const imageField = imageArray[0];
                            const imageUrl = typeof imageField === 'object' ? imageField.url : imageField;
                            
                            if (imageUrl) {
                                generatedImages.push(imageUrl);
                                
                                galleryImageData.set(imageUrl, currentPrompt);
                                
                                const tile = tiles[index];
                                const img = tile.querySelector('.tile-image');
                                const placeholder = tile.querySelector('.tile-placeholder');
                                
                                img.src = imageUrl;
                                img.style.display = 'block';
                                placeholder.style.display = 'none';
                                
                                tile.classList.remove('loading');
                                tile.classList.add('has-image');
                                
                                tile.draggable = true;
                                
                                tile.ondragstart = null;
                                
                                tile.addEventListener('dragstart', (e) => {
                                    e.dataTransfer.effectAllowed = 'copy';
                                    e.dataTransfer.setData('text/uri-list', img.src);
                                    e.dataTransfer.setData('text/plain', img.src);
                                    console.log('Dragging generated image:', img.src);
                                });
                                
                                console.log(` Variation ${index + 1} displayed:`, imageUrl);
                            }
                        } else {
                            console.warn(` No image found in variation ${index + 1}`);
                            const tile = tiles[index];
                            const placeholder = tile.querySelector('.tile-placeholder');
                            placeholder.textContent = 'Failed';
                            tile.classList.remove('loading');
                        }
                    });
                }
                
                if (generatedImages.length > 0) {
                    addToHistory(generatedImages, currentPrompt);
                }
                
                console.log('\n All variations complete. Generated images:', generatedImages);
                // Save to Supabase
if (generatedImages.length > 0) {
    await saveToSupabase(
        { prompt: currentPrompt },
        { workflow: 'surprise-me-text' },
        generatedImages,
        'surprise-me-text'
    );
}
                
            } catch (error) {
                console.error(' Error randomizing image:', error);
                console.error(' Error stack:', error.stack);
                alert(`Failed to randomize image: ${error.message}\n\nCheck console for details.`);
                
                [tile1, tile2, tile3].forEach(tile => {
                    const placeholder = tile.querySelector('.tile-placeholder');
                    placeholder.textContent = 'Error';
                });
            } finally {
                randomizeBtn.disabled = false;
                randomizeBtn.classList.remove('loading');
                randomizeBtn.textContent = originalText;
            }
        });
    </script>
    <!-- Add Supabase Integration -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Get authentication from URL
        const urlParams = new URLSearchParams(window.location.search);
        const authToken = urlParams.get('token');
        const currentUserId = urlParams.get('user_id');

        console.log('Auth status:', { hasToken: !!authToken, userId: currentUserId });

        // Initialize Supabase
        const SUPABASE_URL = 'https://eywujdgxtmozqlzcrqtb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5d3VqZGd4dG1venFsemNycXRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDM2MzgsImV4cCI6MjA4MTE3OTYzOH0.Zoffinj8V_nLJs9Y_eDuqhhV5L5ZiavEw8omx9pD0m0';
        
        let supabaseClient = null;
        
        if (SUPABASE_URL !== 'YOUR_SUPABASE_URL_HERE') {
            const supabaseScript = document.createElement('script');
            supabaseScript.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
            supabaseScript.onload = () => {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                if (authToken) {
                    supabaseClient.auth.setSession({
                        access_token: authToken,
                        refresh_token: authToken
                    }).then(({ data, error }) => {
                        if (error) {
                            console.error('Auth error:', error);
                        } else {
                            console.log(' Supabase authenticated');
                        }
                    });
                }
            };
            document.head.appendChild(supabaseScript);
        }

        // Save generation function
        async function saveToSupabase(inputData, outputData, mediaUrls, generationType) {
            if (!currentUserId) {
                console.log(' No user - skipping save');
                return;
            }

            if (!supabaseClient) {
                console.log(' Supabase not configured');
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('generations')
                    .insert({
                        user_id: currentUserId,
                        tool_id: 'prompt-journey',
                        tool_name: 'Prompt Journey',
                        input_data: {
                            ...inputData,
                            generation_type: generationType
                        },
                        output_data: outputData,
                        media_urls: mediaUrls,
                        status: 'completed'
                    });

                if (error) {
                    console.error(' Supabase error:', error);
                } else {
                    console.log(' Saved to Supabase');
                }
            } catch (err) {
                console.error(' Save error:', err);
            }
        }
    </script>
</body>
</html>